# CarryPigeon 客户端开发指南（精简版）

版本：v1.1（2026-02-07）

> 目标：保留客户端联调必须信息，避免与 `docs/api/*`、`docs/design/*` 重复维护。

## 1. 文档定位与真源

- 本文档负责：客户端联调口径、连接与鉴权主链路、常用协议约束。
- API 设计真源：`docs/api/README.md`（HTTP + WebSocket v1）。
- 当前实现参考：`docs/前端调试与Mock.md`、`src/shared/config/runtime.ts`。
- 产品与架构真源：`docs/design/PRD.md`、`docs/架构设计.md`。

## 2. 全局协议约束（必须）

- JSON 字段：`snake_case`。
- 时间字段：Unix epoch 毫秒（`number` / `long`）。
- 业务登录态：绝大多数业务请求需要先完成 token 登录绑定会话。

### 2.1 通用响应码（CPResponse.code）

- `200`：成功
- `100`：参数/业务失败
- `300`：权限失败（典型：未登录）
- `404`：路由不存在
- `500`：服务端内部错误

推送事件特殊约定：`id = -1` 且 `code = 0`。

## 3. 连接与安全口径

### 3.1 连接分层

- 传输层：TCP（可启用 TLS）。
- 帧层：Netty 长度前缀帧（2-byte length + payload）。
- 业务层：`CPPacket` / `CPResponse` JSON。

### 3.2 安全链路（推荐）

- 先建立 TLS 安全信道，再在信道内完成业务握手。
- 握手成功判定：响应满足 `id = -1`、`code = 0`、`data.route = "handshake"`。
- 业务包使用 AES-GCM（AAD 包含 `sequence + session_id + timestamp`）进行连接级防重放校验。

## 4. 业务报文模型（核心）

### 4.1 请求：`CPPacket`

```json
{
  "id": 12345,
  "route": "/core/user/login/token",
  "data": {
    "token": "..."
  }
}
```

### 4.2 响应：`CPResponse`

```json
{
  "id": 12345,
  "code": 200,
  "data": {}
}
```

建议：无参数时也发送 `"data": {}`，避免反序列化分支复杂化。

## 5. 推送模型（客户端必须处理）

### 5.1 统一封装

- 推送外层统一使用 `CPResponse`。
- 关键识别条件：`id = -1`、`code = 0`、`data.route` 为通知路由。

### 5.2 常见通知路由

- `/core/message`：消息创建/删除通知。
- `/core/channel/message/read/state`：读状态变更。
- `/core/channel/list`：频道列表变更提示。
- `/core/channel/member/list`：成员变更提示。
- `/core/channel/application/list`：申请列表变更提示。
- `/core/channel/ban/list`：禁言列表变更提示。

约定：部分通知 `data = null`，表示“刷新提示”；客户端需主动补拉对应资源。

## 6. 客户端主链路（推荐顺序）

1. 建立连接并完成握手。
2. 获取服务器信息与插件目录。
3. 若 required 插件不满足，先走安装向导。
4. 完成登录并绑定会话。
5. 拉取频道列表与频道消息。
6. 建立实时推送消费（消息/读状态/成员变化）。
7. 执行发送、回复、删除、已读上报。
8. 文件场景走“Netty 申请 token + HTTP 上传下载”。

## 7. 路由与接口文档跳转

- HTTP/WS 统一规范：`docs/api/10-http-ws-protocol-v1.md`
- HTTP 端点清单：`docs/api/11-http-endpoints-v1.md`
- WS 事件清单：`docs/api/12-ws-events-v1.md`
- 错误模型：`docs/api/13-error-model-and-reasons-v1.md`
- 分页游标：`docs/api/14-pagination-and-cursor-v1.md`

## 8. 客户端联调最小自检

- 模式确认：`MOCK_MODE`、`IS_STORE_MOCK`、`USE_MOCK_TRANSPORT`。
- 协议确认：请求 `route` 与 payload 字段命名（`snake_case`）。
- 推送确认：`id=-1/code=0` 路径能正确落到事件分发。
- 规范检查：
  - `npm run lint`
  - `npx vue-tsc --noEmit`
