# 数据库使用指南（多服务器隔离）

本项目支持**同时连接多个服务器**，数据库采用“多连接池 + 多文件”方式隔离。

- 系统库：`/data/db/system.db`
- 服务器库：`/data/db/<server_hash>.db`

其中 `server_hash` 为 `server_socket` 的 **SHA256**（hex）结果，TS 层会自动计算。

---

## 1. 设计原则

- **强隔离**：每个服务器独立 DB 文件，避免混写与误查询
- **低耦合**：TS 通过统一 `DbClient` 调用，Rust 只负责系统级 DB 服务
- **可扩展**：内置基础表与迁移机制，可追加新迁移

---

## 2. 数据库类型

### 2.1 系统库（system）

用于保存全局配置与服务器清单。

默认表（迁移 v1）：
- `app_config(key TEXT PRIMARY KEY, value TEXT, updated_at INTEGER)`
- `servers(server_socket TEXT PRIMARY KEY, server_name TEXT, ecc_public_key TEXT, last_connected_at INTEGER, db_key TEXT, db_path TEXT)`

### 2.2 服务器库（server）

每个服务器一库，仅保存该服务器业务数据。

默认表（迁移 v1）：
- `channels(id INTEGER PRIMARY KEY, name TEXT, owner_id INTEGER, created_at INTEGER)`
- `messages(id TEXT PRIMARY KEY, channel_id INTEGER, user_id INTEGER, content TEXT, created_at INTEGER, updated_at INTEGER)`
- `kv(key TEXT PRIMARY KEY, value TEXT, updated_at INTEGER)`
- 索引：`idx_messages_channel_time(channel_id, created_at)`

> 以上是“基础结构”，后续可通过迁移追加字段或新表。

---

## 3. 自动建表与迁移

Rust 在 `db_init` 时自动执行迁移：
- `key = "system"` → 系统库迁移
- 其他 `key` → 服务器库迁移

迁移记录表：
- `schema_migrations(version INTEGER PRIMARY KEY, name TEXT, applied_at INTEGER)`

---

## 4. TS 侧调用方式

### 4.1 初始化系统库

```ts
import { ensureSystemDb } from "@/shared/db";

await ensureSystemDb();
```

### 4.2 初始化服务器库

```ts
import { ensureServerDb } from "@/shared/db";

await ensureServerDb(serverSocket); // 自动计算 SHA256 + 初始化
```

### 4.3 获取 DbClient 并执行 SQL

```ts
import { getServerDbClient } from "@/shared/db";

const db = getServerDbClient(serverSocket);
await db.execute("INSERT INTO kv(key, value, updated_at) VALUES (?, ?, ?)", [
  "foo",
  "bar",
  Date.now(),
]);

const result = await db.query("SELECT key, value FROM kv", ["key", "value"]);
console.log(result.columns); // ["key", "value"]
console.log(result.rows);    // [["foo", "bar"]]
```

---

## 5. 关闭与删除数据库

### 5.1 关闭连接池

```ts
import { closeServerDb } from "@/shared/db";

await closeServerDb(serverSocket);
```

### 5.2 删除数据库文件

```ts
import { removeServerDb } from "@/shared/db";

await removeServerDb(serverSocket);
```

---

## 6. 查询数据库路径

```ts
import { getServerDbClient } from "@/shared/db";

const db = getServerDbClient(serverSocket);
const path = await db.path();
```

---

## 7. 迁移扩展示例

如需新增表或字段：

1. 在 Rust 侧 `server_migrations()` / `system_migrations()` 中新增更高 `version`
2. 添加对应 SQL
3. 重启后自动执行迁移

---

## 8. 注意事项

- `db_query` 必须传 `columns`，用于返回 `rows` 的列顺序
- 每个服务器库是独立文件，清理不会影响其它服务器
- **请勿**在 UI 层直接调用 `invokeTauri()`，统一使用 `DbClient`
