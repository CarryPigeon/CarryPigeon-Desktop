# 日志与注释规范

本文档用于统一本项目的日志与注释写法，避免：

- `console.*` 到处散落、难以筛选
- 日志格式不一致、缺少上下文
- 关键边界（Tauri/网络/加密）出错时无法定位
- 注释与实现脱节、出现大量注释掉的代码

## 1. 日志规范

### 1.1 工具选择

- 前端通用日志：使用 `src/shared/utils/logger.ts` 的 `createLogger(scope)`
  - 用于 UI / 业务逻辑 / 一般数据层
  - 输出到 `console`，`debug()` 仅在 `DEV` 启用
- 平台边界日志：使用 `src/shared/tauri/tauriLog.ts` 的 `tauriLog`
  - 用于 TCP/加密等关键路径，需要与 Rust 日志统一留存
  - 通过 Tauri command 写入后端日志

### 1.2 约定（必须）

- 禁止在业务代码中直接使用 `console.*`（仅允许在 logger 实现文件里）。
- 日志必须带 `scope`（例如 `createLogger("MainPage")`），便于过滤。
- 日志不要拼接长字符串，优先用结构化 `meta`：
  - ✅ `logger.error("Handshake failed", { serverSocket, error: String(e) })`
  - ❌ `logger.error("Handshake failed: " + e)`
- 不在日志中输出敏感信息（token、密钥、邮箱验证码、私钥等）。

### 1.3 日志级别建议

- `debug`：高频、仅开发期（循环、帧收发、状态机细节）
- `info`：关键流程节点（连接成功、插件加载成功）
- `warn`：可恢复异常/降级（缺少 socket、回退逻辑）
- `error`：不可恢复错误/需要处理（请求失败、解析失败、加密失败）

## 2. 注释规范

### 2.0 强制规范（代码即文档）

本项目将以下三类注释列为强制规范（会通过 ESLint 进行检查）：

- **文档级（文件级）**：每个文件必须有 `@fileoverview`（或 `@file`）说明该文件的职责/边界/关联文档。
- **方法级（函数/公开方法）**：导出的函数、导出类的 `public` 方法必须使用结构化 JSDoc，并包含 `@param` /（必要时）`@returns`。
- **常量级（导出 const）**：导出的 `const` 必须有结构化 JSDoc，并包含 `@constant`（或 `@const`）。

当前强制范围（全局）：

- `src/**/*.{ts,tsx,vue}`（包含 Vue `script` 与普通 TS 文件）

另：Vue SFC 的 **模板（HTML）** 与 **样式（CSS/SCSS）** 也纳入强制规范（见 2.4）。

### 2.1 何时需要注释

- 平台边界：Tauri 调用、TCP/加密、插件 runtime
- 非直观约束：协议字段、帧格式、兼容分支
- 关键决策点：为何这样做（而不是“做了什么”）

### 2.2 禁止事项

- 禁止保留大段“注释掉的代码”（应删除或迁移到分支/提交记录）。
- 禁止无意义注释（重复代码本身的含义）。

### 2.3 推荐格式

- 模块级注释：文件开头用 `/** ... */` 描述职责、边界、关联文档，并包含 `@fileoverview`。
- 导出 API：使用 JSDoc 描述参数、返回值与副作用，包含 `@param` / `@returns` 等标签。
- TODO：用统一标签标注意图：
  - `// TODO(UX): ...`
  - `// TODO(Plugin): ...`
  - `// TODO(Protocol): ...`

#### 2.3.1 文件级模板（必须）

```ts
/**
 * @fileoverview <一句话说明这个文件做什么>
 * @description <可选：更详细的边界/约束/关联文档>
 */
```

#### 2.3.2 方法级模板（必须）

```ts
/**
 * <一句话说明这个方法做什么>
 * @param foo - 参数含义
 * @param bar - 参数含义
 * @returns 返回值含义（如果有返回值）
 */
export function example(foo: string, bar: number): string {
  return `${foo}:${bar}`;
}
```

#### 2.3.3 常量级模板（必须）

```ts
/**
 * @constant
 * @description <该常量的用途/约束>
 */
export const EXAMPLE_EVENT = "carrypigeon:example";
```

### 2.4 HTML / CSS 注释（强制）

本项目的 Vue SFC（`.vue`）要求：

- **模板注释（HTML）**：每个 `<template>` 的第一段内容必须以 `<!-- ... -->` 注释开头，用于说明该组件/页面的职责与关键交互。
- **样式注释（CSS/SCSS）**：每个 `<style>` 块的第一段内容必须以注释开头（`/* ... */`；当 `lang` 支持时允许 `// ...`），用于说明布局策略、关键变量（CSS 变量）与约束。

额外强制：

- **函数级注释（全量）**：`src/**/*.ts` 与 Vue `<script>` 内的所有函数都必须有结构化 JSDoc（含 `@param` / `@returns`）。  
- **HTML 关键位置注释**：模板中关键布局节点（`header/aside/main/section/footer/nav/form/button`）必须在上一行用 `<!-- ... -->` 说明作用。  
- **CSS 选择器注释**：样式中每一个选择器块都必须在上一行添加 `/* ... */` 说明作用。  

以上规则会通过 ESLint 进行检查/约束（函数/模板/样式），确保“代码即文档”落地。

#### 2.4.1 Vue 模板注释模板（必须）

```vue
<template>
  <!-- 页面/组件：<名称>｜职责：<一句话>｜交互：<关键交互> -->
  <div>...</div>
</template>
```

#### 2.4.2 Vue 样式注释模板（必须）

```vue
<style scoped lang="scss">
/* 样式：布局策略｜关键变量：--channel-list-width/--chat-input-height｜约束：... */
</style>
```

### 2.5 独立 HTML / CSS 文件注释（强制）

当仓库中存在独立的 `.html` / `.css` / `.scss` 等文件时，必须遵守：

- **HTML**：`<body>` 内第一段内容必须以 `<!-- ... -->` 注释开头（与 Vue `<template>` 同标准）。
- **HTML 内联样式**：任意 `<style>` 块内容必须以注释开头（默认仅 `/* ... */`；当 `lang` 支持时允许 `// ...`）。
- **独立样式文件**：文件必须以注释开头（`.css` 仅允许 `/* ... */`；预处理器允许 `// ...`）。

这些规则会通过 `npm run lint` / `pnpm lint` 的脚本检查，确保“代码即文档”落地到入口 HTML 与全局样式。
