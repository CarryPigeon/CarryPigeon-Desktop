# CarryPigeon PRD（精简版）

版本：v1.2（2026-02-07）

> 目标：保留产品决策与验收口径，减少与 `docs/design/client/*`、`docs/design/protocol/*`、`docs/design/plugin/*` 的重复描述。

## 0. 产品定位

CarryPigeon 是面向自建服务器的聊天客户端：
- 核心包提供频道群聊基座。
- 垂直能力通过“客户端插件 + 服务端插件”协作扩展。
- 重点保障：可扩展、契约稳定、隔离清晰、安全可控。

## 1. 范围与边界

### 1.1 MVP 目标（必须）

- 打通主链路：连接服务器 → 登录 → 进入频道 → 收发消息 → 回复 → 删除 → 已读未读。
- 打通插件闭环：自定义 domain、渲染、输入（composer）可端到端运行。
- 打通服务器隔离：不同服务器插件集合/版本/缓存互不污染。

### 1.2 非目标（MVP 不做）

- 私聊/好友体系。
- 复杂 RBAC（细粒度权限）。
- 强多端状态一致性承诺。
- 完整插件签名信任体系（规划项）。

### 1.3 强约束

- 核心会话模型：频道群聊。
- 核心权限模型：owner / admin / member + 禁言 + 入群申请。
- 插件安装与运行隔离键使用 `server_id`（`server_socket` 仅用于连接入口与展示）。

## 2. 目标用户与核心场景

- 服务器管理员：需要可控、可扩展、可治理。
- 普通成员：需要稳定、低学习成本的聊天体验。
- 插件开发者：需要明确契约、边界与调试路径。

典型垂直场景：MC 社群、诗词排版、数学公式消息等。

## 3. 核心用户旅程（主流程）

1. 添加服务器并完成连接。
2. 获取服务器信息与插件目录。
3. 若 required 插件不满足，进入安装向导。
4. 完成登录并绑定当前会话。
5. 进入频道并加载历史消息。
6. 消费实时推送并参与消息交互（发送/回复/删除/已读）。

## 4. 功能需求（按优先级）

### 4.1 P0（必须）

- 服务器管理与连接状态。
- 登录/注册/token 登录绑定。
- 频道与成员管理基础能力。
- 消息发送、删除（硬删除）、回复。
- 已读上报与未读展示。
- 插件目录拉取、required gate、安装/启用/禁用/卸载。
- 插件扩展消息 domain（renderer + composer + contract）。

### 4.2 P1（应做）

- 文件上传下载（token + HTTP）。
- 插件更新流程（检查更新、确认更新、失败可回滚）。

### 4.3 P2（规划）

- 插件签名与信任链。
- 更细粒度权限治理与策略中心。

## 5. 插件系统口径（必须）

### 5.1 插件包与运行

- 发布形态：已构建产物（ESM + 静态资源）。
- 不依赖宿主二次编译/转译。
- 可在 PC 与移动端统一运行。

### 5.2 Host API 与权限

- 插件能力必须经宿主白名单 API 注入。
- 禁止插件直接访问宿主敏感状态（token、跨服务器私有缓存等）。
- `storage` 作为按 `server_id` 隔离的默认能力。
- 网络能力必须限制在当前服务器边界及明确下载端点。

### 5.3 Required Gate

当 required 插件未满足时：
- 允许：连接、拉取服务器信息、查看/安装插件。
- 禁止：登录与业务操作。
- 服务端需返回稳定错误原因（如 `required_plugin_missing`）并附 `missing_plugins`。

## 6. 数据与协议口径（产品级）

- 统一消息模型：`mid/cid/uid/send_time/domain/domain_version/data/reply_to_mid?`。
- 删除语义：硬删除；历史拉取与实时视图均不可见。
- 推送最小集：消息 create/delete、读状态、关键刷新提示。
- 未装插件降级：优先展示服务端 `preview`，保证“可读而非空白”。

详细字段与错误码：`docs/design/protocol/*`、`docs/api/*`。

## 7. 非功能要求（P0）

- 安全：最小权限、敏感数据保护、可信边界明确。
- 可靠性：关键链路可观测（连接/登录/发送/拉取/插件加载）。
- 性能：消息列表与推送消费在常见规模下保持可交互。
- 可运维：日志 action 规范统一，错误可定位到域与阶段。

## 8. 验收口径（最小可验）

- 基础聊天闭环可稳定执行。
- required gate 能正确阻断并引导安装。
- 插件 domain 能完成输入、发送、渲染全链路。
- 删除后消息在历史与实时视图中一致消失。
- 未安装插件时消息可降级可读。

## 9. 里程碑建议

- V0：无插件也可稳定聊天。
- V1：插件系统闭环（required + 目录 + 生命周期）。
- V2：自定义 domain 端到端完善（客户端 + 服务端插件协作）。
- V3：生态治理与安全体系增强（签名、审计、策略）。

## 10. 风险与缓解

- 插件质量参差：通过 manifest 校验、权限最小化、回滚机制缓解。
- 协议演进破坏兼容：通过版本协商与兼容策略约束缓解。
- 运行时隔离不足：分阶段推进沙箱化与风险能力下沉。

## 11. 关联文档

- 客户端设计：`docs/design/client/CLIENT-OVERVIEW.md`
- 协议设计：`docs/design/protocol/PROTOCOL-OVERVIEW.md`
- 插件系统：`docs/design/plugin/PLUGIN-SYSTEM.md`
- ADR：`docs/design/decisions/*`
- API 规范：`docs/api/README.md`
