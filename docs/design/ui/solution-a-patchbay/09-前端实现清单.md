# 09｜前端实现清单（把 Patchbay 落地到现有工程）

版本：v1.0  
日期：2026-01-31

> 本清单按“先验收 P0，再打磨体验”的原则排序；每一项都对应可落地的文件/模块。

## P0（直接影响 PRD 验收）

1) 主题切换与 Token 落地
- 修改：`src/App.vue`（新增 `:root[data-theme="patchbay"]` Token，参考 `docs/design/ui/solution-a-patchbay/14-样式落地参考.md`）
- 新增（建议）：`src/shared/utils/theme.ts`
  - `getTheme()` / `setTheme()`（持久化到 localState/localStore）
  - DOM 落点：`document.documentElement.dataset.theme = "patchbay"`
- 接入开关（任选其一）：
  - 设置页：`src/features/settings/presentation/pages/SettingPage.vue`
  - 或 dev flag：`src/shared/config/runtime.ts`

2) required gate 路由与页面
- 路由：`src/app/router.ts`（新增 `/required-setup`）
- 新增页面（建议路径）：`src/features/auth/presentation/pages/RequiredSetupPage.vue`
  - 输入：`missing_plugins[]`（来自登录/注册/token-login 的错误响应）
  - 依赖：插件本地安装态（见下文插件中心 store）
- 登录捕获：
  - 修改：`src/features/auth/presentation/pages/LoginPage.vue`
  - 或更推荐：在 auth service 层统一把服务端错误解析为结构化错误（含 `reason`/`missing_plugins`），页面只负责跳转
- UI 行为（必须）：识别到 `reason="required_plugin_missing"` → `router.replace("/required-setup")`（不要 toast 盖掉原因）

3) 插件中心页面（最小闭环）
- 路由：`src/app/router.ts`（新增 `/plugins`、`/plugins/detail/:pluginId`）
- 新增页面：
  - `src/features/plugins/presentation/pages/PluginCenterPage.vue`
  - `src/features/plugins/presentation/pages/PluginDetailPage.vue`（或抽屉模式）
- 新增组件（建议）：
  - `src/features/plugins/presentation/components/ModuleCard.vue`
  - `src/features/plugins/presentation/components/ModuleDetailDrawer.vue`
  - `src/features/plugins/presentation/components/ModuleProgress.vue`
- 新增 store（按 `server_id` 隔离）：
  - `src/features/plugins/presentation/store/pluginCatalogStore.ts`（server catalog / repo catalog 聚合）
  - `src/features/plugins/presentation/store/pluginInstallStore.ts`（Install/Enable/Update 状态机 + lastError + rollback）
- 复用现有 data 层：
  - `src/features/plugins/data/pluginLoader.ts`（加载产物）
  - `src/features/plugins/data/pluginRuntime.ts`（mount/unmount）

4) 未知 domain 消息降级（需要数据模型支持）
- 数据模型：
  - 调整消息实体（建议）：`docs/design/ui/solution-a-patchbay/13-数据模型与契约.md`
  - 目标：消息列表渲染层必须能拿到 `domain/domain_version/preview?`
- 渲染组件（建议新增）：
  - `src/features/chat/presentation/components/messages/UnknownDomainCard.vue`
  - `src/features/chat/presentation/components/messages/SignalStrip.vue`
- 跳转约定：
  - 点击“安装模块” → `/plugins?focus_plugin_id=<id>&filter=required|all`

## P1（体验与可维护性）

1) Composer Host 升级
- 新增容器组件：
  - `src/features/chat/presentation/components/inputs/ComposerHost.vue`
  - `src/features/chat/presentation/components/inputs/DomainSelector.vue`
  - `src/features/chat/presentation/components/inputs/ReplyBar.vue`
- 复用：
  - 现有 `src/features/chat/presentation/components/inputs/TextArea.vue` 作为 Core 文本 slot
- 插件 composer 对接：
  - 参考 `docs/design/plugin/PLUGIN-COMPOSER-UI.md`（submit/cancel/dirty-change）
  - 插件注册表建议放在：`src/features/plugins/presentation/store/domainRegistry.ts`

2) ConnectionPill（断线弱提示）
- 新增组件：`src/shared/ui/ConnectionPill.vue`（或放在 network feature）
- 新增 store（建议）：`src/features/network/presentation/store/connectionStore.ts`
  - 暴露：`state/reason/detail`（见 `docs/design/ui/solution-a-patchbay/11-状态机与错误码映射.md`）
- 主界面接入：`src/features/chat/presentation/pages/MainPage.vue`（TopConsole 区域）

3) 文案全面 i18n
- 修改：
  - `src/app/i18n/messages/zh_cn.ts`
  - `src/app/i18n/messages/en_us.ts`
- 参考清单：`docs/design/ui/solution-a-patchbay/12-i18n与文案清单.md`

## P2（品牌强化）

- ModuleCard 的“端口/线缆”细节（SVG + CSS 动效）
- Quick Switcher（Ctrl/Cmd+K）统一搜索入口（服务器/频道/插件）

> 备注：若你希望我继续下一步，我可以直接把 P0 的三个 UI 骨架页面（/required-setup、/plugins、/plugins/detail）按方案 A 的样式与组件结构在 `src/features/*/presentation` 中实现出来。
