# 11｜状态机与错误码映射（P0 必备）

版本：v1.0  
日期：2026-01-31

> 目标：把 PRD/协议里的“原因/状态机”映射到 UI 的“状态枚举 + 文案 + 可恢复动作”，避免出现“统一 toast：失败了”。

## 1. 连接状态（ConnectionPill）

状态枚举（前端内部）：

```ts
type ConnectionState = "connected" | "reconnecting" | "offline";
type ConnectionReason =
  | "network_unreachable"
  | "handshake_failed"
  | "version_incompatible"
  | "tls_verify_failed"
  | "timeout"
  | "unknown";
```

UI 映射：
- `connected`：绿 LED + “Connected”
- `reconnecting`：琥珀呼吸 + “Reconnecting…”
- `offline`：红闪 + “Offline” + `Retry` 按钮

Reason → 文案/动作（示例）：
- `network_unreachable`：检查网络/地址；动作：编辑服务器、重试
- `handshake_failed`：协议/兼容性；动作：查看服务器信息、重试
- `version_incompatible`：升级客户端/服务端；动作：复制版本信息、打开关于
- `tls_verify_failed`：TLS 证书校验失败；动作：查看证书/指纹、切换到 TLS Insecure（显式确认）、取消连接

## 2. required 门禁（服务端错误 → UI 路由）

协议（PRD 5.6 / docs/design/protocol/PLUGIN-CATALOG-AND-ERRORS.md）：

- `reason="required_plugin_missing"`
- `missing_plugins[]`

UI 行为（必须稳定）：
- 捕获该 reason 后：`router.replace("/required-setup")`
- 不要显示泛化“登录失败/握手失败”toast（会误导用户）

## 3. 插件中心状态机（Install/Enable/Update）

以 `docs/design/client/PLUGIN-CENTER-FLOWS.md` 为真相，UI 层只做状态显示与可恢复动作。

### 3.1 Install

```ts
type InstallStep =
  | "select_version"
  | "confirm"
  | "downloading"
  | "verifying_sha256"
  | "unpacking"
  | "installed"
  | "failed";
```

失败分支（全部需要“可见原因 + 重试”）：
- download failed → 回到 confirm
- sha256 mismatch → 标记失败并清理本次产物 → 回到 confirm
- unpack failed → 清理解压目录 → 回到 confirm

### 3.2 Enable

```ts
type EnableStep = "enabling" | "enabled" | "failed";
```

失败处理（P0 必须）：
- 任意一步失败 → `status="failed"` + `lastError`
- 若之前已有可用版本：必须保持旧版本继续可用（UI 要显示“当前在用版本”）

### 3.3 Update（原子切换 + 回滚）

```ts
type UpdateStep =
  | "checking"
  | "confirm"
  | "installing"
  | "enabling"
  | "switching"
  | "rollback"
  | "done"
  | "failed";
```

UI 必须展示：
- 新旧版本号
- permissions 变化（新增敏感权限高亮）
- enable 失败时：明确显示“已回滚到旧版本”

## 4. 必需插件清单（Checklist 状态）

```ts
type RequiredItemState =
  | "missing"          // 未安装任何版本
  | "installed"        // 已安装但未启用
  | "enabling"         // 启用中
  | "enabled_ok"       // 启用成功且 ok
  | "enabled_failed";  // 启用失败（lastError 必须可见）
```

进入登录放行条件（建议与流程文档一致）：
- required 列表所有 plugin：`enabled=true && status="ok"`

## 5. 消息发送与失败反馈（P0 建议补齐）

现状：前端存在 optimistic append（`TextArea.vue`），但失败不会对用户可见。

建议最小状态：

```ts
type OutgoingState = "sending" | "sent" | "failed";
```

UI 表现：
- `sending`：气泡右下角小点/进度（不挡内容）
- `failed`：显示红色小标 + “重试”按钮（保留草稿或重新发送）
