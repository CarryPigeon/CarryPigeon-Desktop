# 13｜数据模型与契约（TS 接口 + UI 约束）

版本：v1.0  
日期：2026-01-31

> 目标：把 PRD 的字段语义（domain/preview/required/plugins）落成前端可用的数据模型；并写清 UI 的安全约束（未知 domain 不泄露 data 全量）。

## 1. 消息模型（支持插件渲染/降级）

PRD 6.1/6.3 要求的最小字段：
- `domain`、`domain_version`、`data`、`preview?`、`reply_to_mid?`

建议前端统一消息实体（示例）：

```ts
export interface ChannelMessage {
  mid: number;
  cid: number;
  uid: number;
  send_time: number; // ms
  domain: string;
  domain_version: string;
  data: unknown;     // 插件 payload（未知 domain 不应直接渲染）
  preview?: string;  // 服务端生成的可读预览
  reply_to_mid?: number;
}
```

UI 安全约束（必须）：
- 未安装插件/未知 domain：只能渲染 `preview` 或“需要插件”提示；**禁止 stringify 全量 data**。

## 2. Domain Registry（renderer/composer）

宿主侧需要两个注册表（按 server_id 隔离）：

```ts
export type DomainKey = `${string}:${string}` | string;

export interface DomainRenderer {
  domain: string;
  domain_version: string; // SemVer
  render: (msg: ChannelMessage) => unknown; // Vue VNode / component props
}

export interface DomainComposer {
  domain: string;
  domain_version: string;
  component: unknown; // Vue component
}
```

匹配规则（建议）：
- 先按 `domain` 精确匹配，再按 `domain_version` 兼容范围匹配（SemVer），无法匹配则降级。

## 3. 插件目录与本地安装态（按 server_id）

来自 `docs/design/client/PLUGIN-CENTER-FLOWS.md` 的客户端视角：

```ts
export interface PluginCatalogItem {
  plugin_id: string;
  name: string;
  version: string;
  brief?: string;
  required: boolean;
  permissions?: string[];
  provides_domains?: Array<{ domain: string; domain_version: string }>;
  download?: { url: string; sha256: string; size?: number };
  source: "server" | "repo";
}

export type LocalPluginStatus = "ok" | "disabled" | "failed";

export interface LocalPluginState {
  plugin_id: string;
  installedVersions: string[];
  currentVersion?: string;
  enabled: boolean;
  status: LocalPluginStatus;
  lastError?: string;
  installedFrom?: "server" | "repo";
}
```

## 4. required 门禁数据（向导所需）

向导页面需要：
- `missing_plugins[]`（来自服务端错误）
- 本地安装态（LocalPluginState）

渲染时把 required item 归一化为：

```ts
export interface RequiredItemView {
  plugin_id: string;
  state: "missing" | "installed" | "enabling" | "enabled_ok" | "enabled_failed";
  currentVersion?: string;
  lastError?: string;
}
```

## 5. 路由 query（跨页面定位）

插件中心支持定位与筛选（建议）：

```txt
/plugins?filter=required|all&focus_plugin_id=<plugin_id>&source=server|repo
```

## 6. 主窗口/子窗口事件桥（Tauri 约束）

现状：子窗口无法直接复用主窗口 TCP 连接，需要通过事件桥请求主窗口执行 API。

建议把“插件安装/启用/检查 required”也纳入同一桥接通道（以 server_id 为命名空间），否则 required 向导会在子窗口失去能力。

