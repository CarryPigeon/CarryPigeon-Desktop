# 10｜自检与优化建议（UI 规格完整性）

> 说明：该文件为“旧方案自检”，现行方案为 `docs/ui/方案A-插线板/文档索引.md`。

版本：v1.1  
日期：2026-01-31  
适用范围：CarryPigeon Desktop（Tauri + Vue 3 + TDesign）

## 0. 背景与目标

本文件用于对 `docs/ui/*` 的 UI 规格做一次“对 PRD + 对现有代码”的自检：

- **完整性**：PRD 的 P0 体验点是否都能在 UI 规格中找到落点（页面/组件/状态/文案口径）。  
- **可落地性**：现有代码是否已有入口/基础组件；缺口是否明确、可拆分。  
- **可优化性**：在不改变既有视觉方向（暖纸 + 玻璃 + 邮戳细节）前提下，进一步提升一致性与辨识度。

## 1. 自检结论（摘要）

### 1.1 已覆盖（规格层面）

- 核心主界面信息架构（四栏 + 顶栏）：`docs/ui/05-页面规格-聊天主界面.md`
- 登录与服务器管理/信息弹窗（基础体验）：`docs/ui/04-页面规格-登录与服务器.md`
- P0 的“未知 domain 消息降级”“关键异常分层”“required gate”均已给出口径：`docs/ui/08-状态与错误.md`
- 插件中心/required 安装向导的页面结构与状态机映射已按 `design/client/PLUGIN-CENTER-FLOWS.md` 对齐：`docs/ui/06-页面规格-插件中心与Required向导.md`

### 1.2 主要缺口（规格仍需补齐/细化）

1) **插件 Composer Host 的 UI 规格不够“可实现”**：目前只写了“domain selector + composer slot”，但缺少与 `design/plugin/PLUGIN-COMPOSER-UI.md` 的明确对接（props/emits、失败重试、dirty 状态、回复条与多 domain 切换细节）。  
2) **消息能力不全**：PRD 的“回复（reply_to_mid）”与“硬删除（delete）”在现有 UI 中未形成一致的可见交互规范（现有更接近“撤回/转发/复制”菜单）。  
3) **连接状态（push 断连/重连）仅停留在建议**：缺少具体组件规格（放置位置、状态枚举、交互）与落地入口。  
4) **i18n 与文案一致性**：部分现有实现存在硬编码中文/英文混用（例如输入框 placeholder），需要 UI 规格给出“必须 i18n 的清单与规范”。

### 1.3 主要缺口（实现层面：代码尚未具备）

> 这不是 UI 文档的问题，但会影响“是否能按规格落地”。

- `/plugins`、`/required-setup` 等路由尚未实现（但入口菜单已有 `plugins` action）。  
- 消息数据模型仍以 `content: string` 为主，尚未包含 `domain/domain_version/preview` 等字段，导致“未知 domain 降级”无法真正渲染。  

## 2. 完备性矩阵（PRD → UI 规格 → 代码现状）

标记说明：
- ✅：规格已覆盖且代码已有基础/入口  
- 🟡：规格已覆盖但代码缺口较大 / 或规格需再细化  
- ❌：规格缺失（需要补写）

| PRD 关键点（P0） | UI 规格落点 | 代码现状 |
|---|---|---|
| required 插件 gate（阻止登录，引导安装） | `docs/ui/04...` + `docs/ui/06...` + `docs/ui/08...` | 🟡（缺少 `/required-setup` 与插件中心页面） |
| 插件中心安装/启用/更新/回滚状态机 | `docs/ui/06...` | 🟡（仅 data 层有 `features/plugins/data/*`） |
| 未装插件消息降级（preview 优先） | `docs/ui/05...` + `docs/ui/08...` + `docs/ui/ascii/05...` | 🟡（消息模型未包含 domain/preview） |
| 连接失败原因区分（可操作提示） | `docs/ui/04...` + `docs/ui/08...` | 🟡（现有登录失败多为统一 toast） |
| 推送断连弱提示 + 恢复补齐 | `docs/ui/05...` + `docs/ui/08...` | 🟡（缺少连接状态组件与状态来源） |
| 回复（reply_to_mid） | `docs/ui/05...`（建议态） | 🟡（未形成 UI 交互，未见 reply 动作） |
| 删除=消失（硬删除） | `docs/ui/05...` + `docs/ui/08...` | 🟡（现有“撤回”动作仅覆盖自己消息；缺少统一文案与失败回滚提示） |
| 已读/未读基础 | `docs/ui/05...`（弱提及） | ✅/🟡（有 unread 提示与 updateReadState，但缺少明确 UI 指示） |

## 3. 可进一步优化（按优先级）

### P0（直接影响 PRD 验收）

1) **把 Input Pane 明确升级为 Composer Host 规格**（对齐 `design/plugin/PLUGIN-COMPOSER-UI.md`）：  
   - domain 切换（Core 与插件 domain 的展示与排序）  
   - submit/失败重试/保留草稿/dirty-change  
   - 回复条（reply_to_mid）的出现、取消、与发送行为绑定  
2) **把消息菜单语义统一到 PRD 的“删除（硬删除）/回复/转发”**：  
   - “撤回”与“删除”的命名/权限差异写清楚（例如仅本人可删除、管理员可删等）  
3) **把 required gate 的体验写成“可截图的流程”**：  
   - 登录页收到 `required_plugin_missing` → 跳转向导 → 插件中心 Required 视图 → 启用成功 → 回到登录放行  

### P1（显著提升使用体验，但不阻塞验收）

1) **连接状态条（ConnectionStatusPill）规格落地**：状态枚举、放置位置、弱提示策略、重试按钮。  
2) **全站文案与 i18n 规范**：  
   - UI 规格补一个“必须 i18n 的文案清单”（placeholder、空状态、按钮、错误原因）。  
3) **Modal/Popover 视觉一致性**：目前不同 Modal 的 overlay/阴影策略不完全一致，建议统一到 `--cp-shadow(--soft)` 与同一遮罩配方。

### P2（品牌强化 / 质感提升）

1) **邮戳元素系统化**：required/official/failed/update 四类徽章统一视觉语言（边框、纹理、角标）。  
2) **列表骨架屏**：频道/成员/插件列表加载时用“纸张条目”骨架，减少白屏与跳动。  
3) **键盘效率**（桌面客户端价值点）：  
   - `Ctrl/Cmd+K` 搜索频道/成员/插件  
   - `Esc` 关闭浮层（现有已做）+ 清除输入焦点  

## 4. 建议补写/增补到现有 UI 规格的内容（最小集合）

把以下内容补进 `docs/ui/05-页面规格-聊天主界面.md` 与 `docs/ui/09-前端实现清单.md`（后续拆分也可）：

- Composer Host 的契约对接点：引用 `design/plugin/PLUGIN-COMPOSER-UI.md`，并写清“宿主负责的 UI 状态”（disabled、sending、error、draft）。  
- “回复/删除”的 UI 规则：哪些角色能做、动作名、成功/失败反馈、与消息列表的表现。  
- “未知 domain 降级卡片”的最小字段：`domain/domain_version/preview/plugin_id?`（plugin_id 若由服务端提供更佳）。  

## 5. 变更记录

- 2026-01-31：新增自检与优化建议；输出 PRD→规格→代码现状矩阵与下一步优化优先级。
